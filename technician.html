<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Technician Workspace | GearGuard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <style>
      :root {
        --bg: #f8f6f4;
        --mint-light: #d2e9e9;
        --mint-dark: #a5d0d0;
        --danger: #ff4d4d;
      }
      body {
        background-color: var(--bg);
        font-family: "Segoe UI", sans-serif;
        overflow-x: hidden;
      }

      /* Kanban Column Styling */
      .kanban-column {
        min-width: 320px;
        height: calc(100vh - 150px);
        background-color: #ebf5f5;
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s ease;
      }

      /* Task Card Styling */
      .kanban-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-left: 5px solid transparent;
        transition: transform 0.2s ease;
      }
      .kanban-card:hover {
        transform: translateY(-2px);
      }
      .kanban-card.overdue {
        border-left-color: var(--danger);
      }
      .kanban-card.claimed {
        border-left-color: #3b82f6;
        cursor: grab;
      }
      .kanban-card.claimed:active {
        cursor: grabbing;
      }

      .btn-claim {
        background-color: var(--mint-dark);
        color: white;
        padding: 0.5rem;
        width: 100%;
        border-radius: 6px;
        font-weight: bold;
        font-size: 0.75rem;
        transition: background 0.3s;
      }
      .btn-claim:hover {
        background-color: #83b7b7;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Technician Dashboard</h1>
        <p class="text-sm text-gray-500">
          Available jobs for:
          <span class="font-bold text-[#83B7B7]">Mechanic Team</span>
        </p>
      </div>
      <div
        class="flex items-center space-x-4 bg-white p-2 rounded-lg shadow-sm border border-[#D2E9E9]"
      >
        <div class="text-right">
          <p class="text-xs font-bold" id="tech-name">Aryan Patel</p>
          <p class="text-[10px] text-gray-400">Senior Technician</p>
        </div>
        <div
          class="w-10 h-10 rounded-full bg-[#A5D0D0] flex items-center justify-center text-white font-bold"
        >
          AP
        </div>
      </div>
    </div>

    <div class="flex space-x-6 overflow-x-auto pb-6">
      <div class="kanban-column" id="New">
        <h2
          class="font-bold text-gray-700 mb-4 flex items-center justify-between uppercase text-xs tracking-wider"
        >
          Open Requests
          <span class="bg-white px-2 py-1 rounded text-[10px]">1</span>
        </h2>

        <div class="kanban-card overdue" id="req_101">
          <div class="flex justify-between items-start mb-2">
            <span class="text-[10px] font-bold text-red-500 uppercase"
              ><i class="fa fa-clock-o"></i> Overdue</span
            >
            <span class="text-[10px] bg-gray-100 px-2 py-1 rounded font-mono"
              >#101</span
            >
          </div>
          <h3 class="font-bold text-sm text-gray-800">
            Engine Failure - Forklift B2
          </h3>
          <p class="text-xs text-gray-500 mb-4">Location: Production Hall A</p>

          <button onclick="claimTask('req_101')" class="btn-claim">
            PICK UP TASK
          </button>
        </div>
      </div>

      <div
        class="kanban-column"
        id="In-Progress"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h2
          class="font-bold text-gray-700 mb-4 uppercase text-xs tracking-wider"
        >
          My Active Work
        </h2>
      </div>

      <div
        class="kanban-column"
        id="Repaired"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h2
          class="font-bold text-green-600 mb-4 uppercase text-xs tracking-wider"
        >
          Completed / Repaired
        </h2>
      </div>

      <div
        class="kanban-column"
        id="Scrap"
        ondrop="drop(event)"
        ondragover="allowDrop(event)"
      >
        <h2
          class="font-bold text-red-500 mb-4 uppercase text-xs tracking-wider"
        >
          Scrap
        </h2>
      </div>
    </div>

    <div
      id="repairModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-300"
      >
        <div class="p-4 bg-[#D2E9E9] font-bold flex justify-between">
          <span>Finalize Repair</span>
          <button onclick="closeModal()" class="text-xl">&times;</button>
        </div>
        <div class="p-6">
          <p class="text-sm text-gray-600 mb-4">
            Great job! How long did this repair take?
          </p>
          <label class="block text-xs font-bold uppercase text-gray-400 mb-1"
            >Time Spent (Hours)</label
          >
          <input
            type="number"
            id="duration"
            step="0.5"
            class="w-full border p-2 rounded bg-[#F8F6F4] focus:ring-2 focus:ring-[#A5D0D0] outline-none"
            placeholder="e.g. 1.5"
          />

          <div class="flex justify-end space-x-3 mt-6">
            <button
              onclick="closeModal()"
              class="text-xs font-bold text-gray-400"
            >
              CANCEL
            </button>
            <button
              onclick="submitCompletion()"
              class="bg-[#A5D0D0] text-white px-6 py-2 rounded font-bold text-xs hover:bg-[#83B7B7]"
            >
              SUBMIT TO ADMIN
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentActiveTask = null;

      // --- 1. Claiming Logic ---
      function claimTask(taskId) {
        const technicianName = document.getElementById("tech-name").innerText;
        if (confirm(`Do you want to claim this task, ${technicianName}?`)) {
          const card = document.getElementById(taskId);

          // Update UI: Move to In Progress
          const targetCol = document.getElementById("In-Progress");
          targetCol.appendChild(card);

          // Transform Card into a Claimed Task
          card.classList.remove("overdue");
          card.classList.add("claimed");
          card.setAttribute("draggable", "true");
          card.setAttribute("ondragstart", "drag(event)");

          // Remove the claim button and add technician name badge
          card.querySelector("button").remove();
          const badge = document.createElement("div");
          badge.className = "flex items-center mt-3 pt-3 border-t";
          badge.innerHTML = `<div class="w-5 h-5 rounded-full bg-blue-100 text-[8px] flex items-center justify-center mr-2 font-bold">AP</div>
                                   <span class="text-[10px] text-gray-500 font-bold">Assigned to Me</span>`;
          card.appendChild(badge);

          // Note for Backend: Here you would execute a fetch() to update technician_id in DB
          console.log(
            "Backend Trigger: Update Task ID " +
              taskId +
              " with Technician: " +
              technicianName
          );
        }
      }

      // --- 2. Drag & Drop Logic ---
      function allowDrop(ev) {
        ev.preventDefault();
      }
      function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
      }

      function drop(ev) {
        ev.preventDefault();
        const taskId = ev.dataTransfer.getData("text");
        const card = document.getElementById(taskId);
        const targetCol = ev.target.closest(".kanban-column");

        if (!targetCol) return;

        // Logic for Repaired Status
        if (targetCol.id === "Repaired") {
          currentActiveTask = card;
          document.getElementById("repairModal").style.display = "flex";
        }
        // Logic for Scrap Status
        else if (targetCol.id === "Scrap") {
          if (
            confirm(
              "DANGER: Moving to Scrap will permanently decommission this equipment. Confirm?"
            )
          ) {
            targetCol.appendChild(card);
            console.log(
              "Backend Trigger: Equipment associated with " +
                taskId +
                " marked as SCRAPPED."
            );
          }
        } else {
          targetCol.appendChild(card);
        }
      }

      // --- 3. Completion Logic ---
      function submitCompletion() {
        const hours = document.getElementById("duration").value;
        if (!hours) {
          alert("Please enter the time spent.");
          return;
        }

        // Move card to Repaired column
        document.getElementById("Repaired").appendChild(currentActiveTask);

        // Note for Backend: Update DB status to 'Repaired' and set duration = hours
        console.log(
          "Backend Trigger: Task " +
            currentActiveTask.id +
            " completed in " +
            hours +
            " hours."
        );

        closeModal();
        alert("Success! Admin has been notified of the repair.");
      }

      function closeModal() {
        document.getElementById("repairModal").style.display = "none";
      }
    </script>
  </body>
</html>
